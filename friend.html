<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§Ö‡§Ç‡§ú‡§≤‡•Ä ‚Ä¢ ‡§Æ‡§ø‡§§‡•ç‡§∞</title>

<style>
body{
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  font-family:system-ui,"Noto Sans Devanagari",sans-serif;
  background:#fff6f1;
}
.header{
  padding:14px;
  text-align:center;
  background:#fde7dc;
  border-bottom:1px solid #e6b2b2;
}
.header h1{margin:0;font-size:20px;color:#8b2d2d}
.header p{margin:4px 0 0;font-size:12px;color:#6b2c2c}

.chat{
  flex:1;
  padding:14px;
  overflow-y:auto;
}
.msg{
  max-width:80%;
  padding:10px 12px;
  margin:8px 0;
  border-radius:14px;
  line-height:1.4;
  white-space:pre-wrap;
  font-size:14px;
}
.user{margin-left:auto;background:#ffe8dc}
.anjali{background:#ffffff;border:1px solid #f1c6b8}

.controls,.inputArea{
  padding:10px;
  display:flex;
  gap:8px;
  background:#fff;
  border-top:1px solid #e6b2b2;
}
.controls button,
.inputArea button{
  flex:1;
  border:none;
  border-radius:12px;
  padding:10px;
  font-size:14px;
  cursor:pointer;
  background:#c96a6a;
  color:#fff;
}
.inputArea{display:none}
input{
  flex:1;
  padding:10px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:14px;
}
</style>
</head>

<body>

<div class="header">
  <h1>‡§Ö‡§Ç‡§ú‡§≤‡•Ä</h1>
  <p>‡§Æ‡•à‡§Ç ‡§Ø‡§π‡•Ä‡§Ç ‡§π‡•Ç‡§Å‚Ä¶ ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•á ‡§∏‡§æ‡§•</p>
</div>

<div class="chat" id="chatBox">
  <div class="msg anjali">
    ‡§ú‡§¨ ‡§§‡•Å‡§Æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã,  
    ‚Äú‡§¨‡§æ‡§§‡§ö‡•Ä‡§§ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç‚Äù ‡§¶‡§¨‡§æ‡§ì üå∏
  </div>
</div>

<div class="controls">
  <button onclick="startChat()">üí¨ ‡§¨‡§æ‡§§‡§ö‡•Ä‡§§ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
  <button onclick="startListening()">üé§ ‡§¨‡•ã‡§≤‡§ï‡§∞ ‡§¨‡§§‡§æ‡§ì</button>
</div>

<div class="inputArea" id="inputArea">
  <input id="textInput" placeholder="‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•ã‚Ä¶" />
  <button onclick="sendText()">‡§≠‡•á‡§ú‡•á‡§Ç</button>
</div>

<!-- FRIEND CORE -->
<script src="core/AnjaliCore.js"></script>

<!-- FRIEND INITIATIVE -->
<script src="core/AnjaliInitiative.js"></script>

<!-- FRIEND MEMORY -->
<script src="core/AnjaliMemory.js"></script>

<!-- FRIEND RESPONSE GENERATOR (NEW) -->
<script src="core/AnjaliResponseGenerator.js"></script>
  <script src="core/AnjaliToneLayer.js"></script>
  <!-- FRIEND VOICE (NEW, NOT TEACHER) -->
<script src="voice/anjali_friend_tts.js"></script>

<script>
const chatBox = document.getElementById("chatBox");
const input = document.getElementById("textInput");
const inputArea = document.getElementById("inputArea");

let chatStarted = false;

/* utility */
function addMsg(text, who){
  const d = document.createElement("div");
  d.className = "msg " + who;
  d.textContent = text;
  chatBox.appendChild(d);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* START CHAT */
function startChat(){
  if(chatStarted) return;
  chatStarted = true;

  inputArea.style.display = "flex";
  input.focus();

  const welcome = "‡§Æ‡•à‡§Ç ‡§Ø‡§π‡§æ‡§Å ‡§π‡•Ç‡§Å‡•§ ‡§ß‡•Ä‡§∞‡•á-‡§ß‡•Ä‡§∞‡•á ‡§ú‡•ã ‡§Æ‡§® ‡§Æ‡•á‡§Ç ‡§π‡•à, ‡§ï‡§π‡•ã‡•§";
  addMsg(welcome, "anjali");

  if(window.speechSynthesis){
    speechSynthesis.cancel();
    speechSynthesis.speak(new SpeechSynthesisUtterance(welcome));
  }
}

/* SEND TEXT */
function sendText(){
  const text = input.value.trim();
  if(!text) return;
  input.value = "";

  addMsg(text, "user");

  /* MEMORY */
  if (window.AnjaliMemory) {
    AnjaliMemory.remember(text);
  }

  /* CORE RESPONSE (baseline presence) */
  let reply = AnjaliCore.handleInput(text);

  /* RESPONSE GENERATOR (always adds flow + question) */
  if (window.AnjaliResponseGenerator) {
    const flow = AnjaliResponseGenerator.generate(text);
    reply = reply ? reply + " " + flow : flow;
  }

  addMsg(reply, "anjali");

  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(reply));
}

/* ENTER KEY */
input.addEventListener("keydown", e=>{
  if(e.key === "Enter") sendText();
});

/* VOICE */
function startListening(){
  startChat();

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    addMsg("‡§Æ‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡§æ‚Ä¶ ‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡§º‡•ã‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "anjali");
    return;
  }

  const rec = new SR();
  rec.lang = "hi-IN";
  rec.interimResults = false;
  rec.continuous = false;

  addMsg("‡§Æ‡•à‡§Ç ‡§∏‡•Å‡§® ‡§∞‡§π‡•Ä ‡§π‡•Ç‡§Å‚Ä¶ ‡§¨‡•ã‡§≤‡•ã‡•§", "anjali");

  rec.onresult = e=>{
    const text = e.results[0][0].transcript.trim();
    addMsg(text, "user");

    if (window.AnjaliMemory) {
      AnjaliMemory.remember(text);
    }

    let reply = AnjaliCore.handleInput(text);

    if (window.AnjaliResponseGenerator) {
      const flow = AnjaliResponseGenerator.generate(text);
      reply = reply ? reply + " " + flow : flow;
    }

    addMsg(reply, "anjali");

    speechSynthesis.cancel();
    speechSynthesis.speak(new SpeechSynthesisUtterance(reply));
  };

  rec.onerror = ()=>{
    addMsg("‡§Æ‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡§æ‚Ä¶ ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§∏‡§Æ‡§ù ‡§®‡§π‡•Ä‡§Ç ‡§Ü‡§à‡•§", "anjali");
  };

  rec.start();
}
</script>

</body>
</html>
